<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NovelHub · Library</title>
  <link rel="stylesheet" href="styles.css"/>
  <meta name="description" content="Read web novels with progress sync, bookmarks, comments.">
</head>
<body>
  <header class="nav container">
    <div class="brand">
      <div class="logo"></div>
      <h1>NovelHub</h1>
    </div>
    <div class="actions">
      <a href="auth.html" id="authLink">Log in</a>
      <button id="logout" style="display:none">Log out</button>
      <a href="admin.html">Admin</a>
      <button id="theme">Theme</button>
    </div>
  </header>

  <main class="container">
    <div class="searchbar">
      <input id="q" placeholder="Search novels by title or author..."/>
      <button id="searchBtn">Search</button>
    </div>

    <section id="continue"></section>
    <div id="grid" class="grid"></div>
  </main>

  <footer>© <span id="y"></span> NovelHub</footer>

  <script type="module">
    import { sb } from './js/supabaseClient.js';
    import { $, html, timeAgo, Theme } from './js/utils.js';

    Theme.load();
    document.getElementById('theme').onclick = Theme.toggle;

    const year = new Date().getFullYear();
    document.getElementById('y').textContent = String(year);

    // Auth UI
    const session = (await sb.auth.getSession()).data.session;
    const user = session?.user ?? null;
    document.getElementById('authLink').style.display = user ? 'none' : '';
    document.getElementById('logout').style.display = user ? '' : 'none';
    document.getElementById('logout').onclick = async () => { await sb.auth.signOut(); location.reload(); };

    // Load novels
    let novels = (await sb.from('novels').select('*').eq('is_published', true).order('updated_at', { ascending:false })).data ?? [];

    function render(list){
      const grid = $('#grid'); grid.innerHTML = '';
      for (const n of list){
        const card = html`
          <article class="card">
            <img src="${n.cover_url || 'https://picsum.photos/seed/'+encodeURIComponent(n.slug)+'/400/600'}" alt="${n.title} cover">
            <div class="pad">
              <span class="badge">${n.author || 'Unknown'}</span>
              <h3>${n.title}</h3>
              <p>${(n.description||'').slice(0,160)}</p>
              <p class="meta">Updated ${n.updated_at ? timeAgo(n.updated_at) : ''}</p>
              <p style="margin-top:8px"><a class="btn" href="reader.html?novel=${encodeURIComponent(n.slug)}&ch=1">Start reading →</a></p>
            </div>
          </article>`;
        grid.append(card);
      }
    }
    render(novels);

    // Search
    document.getElementById('searchBtn').onclick = () => {
      const q = ($('#q').value || '').toLowerCase();
      if (!q) { render(novels); return; }
      const flt = novels.filter(n => (n.title||'').toLowerCase().includes(q) || (n.author||'').toLowerCase().includes(q));
      render(flt);
    };

    // Continue reading (first match)
    if (user) {
      for (const n of novels) {
        const prog = (await sb.from('reading_progress').select('last_chapter_index').eq('novel_id', n.id).maybeSingle()).data;
        if (prog?.last_chapter_index) {
          const el = $('#continue');
          el.innerHTML = '';
          el.append(html`
            <div class="form">
              <p>Continue <strong>${n.title}</strong> at chapter ${prog.last_chapter_index}</p>
              <a class="btn" href="reader.html?novel=${encodeURIComponent(n.slug)}&ch=${prog.last_chapter_index}">Resume</a>
            </div>
          `);
          break;
        }
      }
    }
  </script>
</body>
</html>
