<!doctype html>
<html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Â· NovelHub Pro</title>
<link rel="stylesheet" href="styles.css"/>
</head><body>
<header class="nav container"><div class="brand"><div class="logo"></div><h1>Admin</h1></div><div class="actions"><a href="index.html">Home</a></div></header>
<main class="container">
  <p class="meta">Works only when Supabase is configured and your user UUID is in <code>public.admins</code>. In DEMO mode, forms are disabled.</p>
  <div class="article">
    <h2>Create / Update Novel</h2>
    <input id="n_slug" placeholder="slug"> <input id="n_title" placeholder="title"><br><br>
    <input id="n_author" placeholder="author"> <input id="n_tags" placeholder="tags (comma separated)"><br><br>
    <textarea id="n_desc" rows="4" placeholder="description"></textarea><br>
    <input id="n_cover_url" placeholder="cover url"><br><br>
    <button class="btn" id="save_novel">Save Novel</button>
  </div>
  <div class="article">
    <h2>Add / Edit Chapter</h2>
    <input id="c_slug" placeholder="novel slug"> <input id="c_index" type="number" value="1" min="1"><br><br>
    <input id="c_title" placeholder="Chapter title"><br><br>
    <textarea id="c_content" rows="10" placeholder="<p>HTML content...</p>"></textarea><br>
    <button class="btn" id="create_chapter">Create</button>
    <button class="btn" id="update_chapter">Update</button>
    <button class="btn" id="delete_chapter">Delete</button>
  </div>
</main>
<script type="module">
import { sb, DEMO } from './js/supabaseClient.js';
if (DEMO){ for (const id of ['save_novel','create_chapter','update_chapter','delete_chapter']) document.getElementById(id).onclick=()=>alert('Admin disabled in DEMO mode'); }
else {
  async function isAdmin(){
    const u = (await sb.auth.getUser()).data.user; if(!u) return null;
    const { data } = await sb.from('admins').select('user_id').eq('user_id', u.id).maybeSingle(); return data? u : null;
  }
  const user = await isAdmin(); if (!user) alert('Not admin or not logged in.');

  document.getElementById('save_novel').onclick = async ()=>{
    const payload = {
      slug: n_slug.value.trim(), title: n_title.value.trim(), author: n_author.value.trim()||null,
      description: n_desc.value.trim()||null, cover_url: n_cover_url.value.trim()||null,
      tags: n_tags.value.split(',').map(x=>x.trim()).filter(Boolean)
    };
    const existed = (await sb.from('novels').select('id').eq('slug', payload.slug).maybeSingle()).data;
    let error; if (existed) ({ error } = await sb.from('novels').update(payload).eq('id',existed.id));
    else ({ error } = await sb.from('novels').insert(payload));
    alert(error? error.message : 'Saved.');
  };

  async function getNovelId(slug){ const { data } = await sb.from('novels').select('id').eq('slug', slug).single(); return data.id; }

  document.getElementById('create_chapter').onclick = async ()=>{
    const nv = await getNovelId(c_slug.value.trim());
    const payload = { novel_id:nv, index_in_novel:Number(c_index.value), title:c_title.value.trim()||`Chapter ${c_index.value}`, content:c_content.value.trim(), is_published:true };
    const { error } = await sb.from('chapters').insert(payload); alert(error? error.message : 'Chapter created.');
  };
  document.getElementById('update_chapter').onclick = async ()=>{
    const nv = await getNovelId(c_slug.value.trim());
    const row = (await sb.from('chapters').select('id').eq('novel_id',nv).eq('index_in_novel',Number(c_index.value)).maybeSingle()).data;
    if (!row) return alert('Not found');
    const { error } = await sb.from('chapters').update({ title:c_title.value.trim(), content:c_content.value.trim() }).eq('id', row.id);
    alert(error? error.message : 'Updated.');
  };
  document.getElementById('delete_chapter').onclick = async ()=>{
    const nv = await getNovelId(c_slug.value.trim());
    const row = (await sb.from('chapters').select('id').eq('novel_id',nv).eq('index_in_novel',Number(c_index.value)).maybeSingle()).data;
    if (!row) return alert('Not found');
    const { error } = await sb.from('chapters').delete().eq('id',row.id);
    alert(error? error.message : 'Deleted.');
  };
}
</script>
</body></html>
